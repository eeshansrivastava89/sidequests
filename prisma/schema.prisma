generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Project {
  id            String    @id @default(cuid())
  name          String
  pathHash      String    @unique
  pathDisplay   String
  pinned        Boolean   @default(false)
  lastTouchedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  prunedAt      DateTime?

  scan     Scan?
  derived  Derived?
  llm      Llm?
  override Override?
  metadata Metadata?
  activity Activity[]
}

model Scan {
  id          String   @id @default(cuid())
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rawJson     String   // Full scan output as JSON
  rawJsonHash String?  // SHA-256 hash of rawJson for change detection
  scannedAt   DateTime @default(now())
}

model Derived {
  id                 String    @id @default(cuid())
  projectId          String    @unique
  project            Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  statusAuto         String    // active, paused, stale, archived
  healthScoreAuto    Int
  hygieneScoreAuto   Int       @default(0)
  momentumScoreAuto  Int       @default(0)
  scoreBreakdownJson String    @default("{}")
  derivedJson        String    // Full derived output as JSON (tags, etc.)
  isDirty            Boolean   @default(false)
  ahead              Int       @default(0)
  behind             Int       @default(0)
  framework          String?
  branchName         String?
  lastCommitDate     DateTime?
  locEstimate        Int       @default(0)
}

model Llm {
  id                     String    @id @default(cuid())
  projectId              String    @unique
  project                Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  purpose                String?
  tagsJson               String?   // JSON array
  notableFeaturesJson    String?   // JSON array
  recommendationsJson    String?   // JSON array
  pitch                  String?
  aiInsightJson          String?   // JSON: { score, confidence, reasons, risks, nextBestAction }
  aiInsightGeneratedAt   DateTime?
  generatedAt            DateTime  @default(now())
}

model Override {
  id              String   @id @default(cuid())
  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  statusOverride  String?
  purposeOverride String?
  tagsOverride    String?  // JSON array
  notesOverride   String?
  updatedAt       DateTime @updatedAt
}

model Metadata {
  id             String  @id @default(cuid())
  projectId      String  @unique
  project        Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  goal           String?
  audience       String?
  successMetrics String?
  nextAction     String?
  publishTarget  String?
}

model Activity {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type        String   // e.g. "scan", "override", "llm", "metadata"
  payloadJson String?
  createdAt   DateTime @default(now())

  @@index([projectId, createdAt])
}
